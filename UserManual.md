# Руководство пользователя

## Установка
Распакуйте архив стандартными средствами Windows в любой удобной папке. Программе не нужны права администратора, она не захламляет реестр и нигде не регистрируется. Можно запускать даже с флэшки.

## Использование
Отчеты брокера ВТБ формата XML нужно поместить в директрию data/reports/vtb. Именно XML, не XLS, не PDF. Получить их можно в личном кабинете на сайте https://lk.olb.ru/Reports/Broker. 

Для выполнения программы нужно запустить файл run.bat. Программа по умолчанию исполняет задания из файла Task.xml и помещает результаты в файл result.txt. Подробности по составлению заданий в разделе "Описание форматов данных".

## Описание форматов данных

### Задачи Task.xml

#### Тег task

Означает одну задачу, которую будет выполнять программа и выводить отчет по её результатам. Промежуточные результаты действий не выводятся. Таких тегов может быть сколько угодно. Для каждого будет выведен отдельный результат.

Аттрибуты

* name задает описание задачи. На результат не влияет.
* hide_parts_less исключает из результатов группы с долей менее указанной. Доля указывается в процентах. При этом доли не пересчитываются, исключенные группы просто не отображаются. Например, есть две группы в 70% и 30%. При hide_parts_less="50" в результате останется первая группа с долей 70%.
* order_by определяет порядок сортировки результата. Допустимые значения: "key" - по названию группы (наименование страны, валюты и тд), "part" - по размеру группы. Через точку с запятой можно дописать "desc", тогда результат будет упорядочен по убыванию, например, "part;desc". По умолчанию сортировка по размеру по возрастанию.
* remove_isins, remove_tickers указывает какие бумаги нужно удалить из результата. При этом доли будут пересчитаны.
* keep_only_isins, keep_only_tickers указывает какие бумаги нужно оставить в результате, а остальные удалить. При этом доли будут пересчитаны.

Внутри тега task могут встречаться теги действий, описанные ниже.

#### Тег group

Внутри тега task могут встречаться теги group в произвольном количестве. Они группируют портфель по указанному критерию. Каждый следующий тег группирует результат выполнения предыдущего. Таким образом можно сначала сгруппировать портфель по типу активов, оставить только акции, сгруппировать их по странам, исключить российские, сгруппировать оставшиеся по секторам экономики. В итоге получим зарубежные акции, сгруппированные по секторам.

Аттрибуты

* by указывает критерий группировки. Обязательный аттрибут. Доступные значения: 
	* country - по странам
	* currency - по валютам
	* type - по типам актива
	* sector - по секторам экономики
* unpack_etf указывает нужно ли заглядывать внутрь ETF при группировке по типам актива. При друггих группировка это делается всегда автоматически. Если значение равно yes, то в результате не будет группы с названием etf. Всё её содержимое будет распределено по остальным группам в долях, указанных в файле data/info/securities.xml в описании соответствующего фонда.
* remove_keys указывает какие группы нужно удалить из результата. При этом доли будут пересчитаны для оставшихся групп. Например, портфель состоит из акций и облигаций поровну. При remove_keys="bond", останется одна группа share, занимающая 100%.
* keep_only_keys указывает какие группы нужно оставить в результате, а остальные удалить. В остальном аналогично remove_keys 

#### Теги buy/sell

Действия для просмотра, что будет с результатами группироки при докупке/продаже бумаг. Должно располагаться до первого действия группировки group. 

Аттрибуты

Обязательно должен быть аттрибут isin или ticker, указывающий на бумагу. Эта бумага должна быть в базе securities.xml.

* isin 
* ticker
* count указывает сколько бумаг купить или продавать. Если при продаже указано больше, чем есть, это не страшно, продадутся все имеющиеся. Обязательный аттрибут для покупки, для продажи можно опустить count, тогда продадутся все имеющиеся.
* price указывает цену покупки. Для новых бумаг при покупке обязательно должна быть указана цена. Для уже имеющихся это не обязательно, при отсутствии аттрибута price будет использована старая цена. Если указать цену, то она будет использована и для старых бумаг. Для продажи цена не указывается. Продажа всегда по текущей цене.
* use_cash указывает будет ли пересчитана наличка. То есть, эмулирована реальная сделка. При значении "no" будет происходить только добавление или удаление бумаги. При любых других значениях или отсутствии аттрибута будет эмулироваться реальная сделка с добавление или убавлением налички. Баланс портфеля останется неизменным.
