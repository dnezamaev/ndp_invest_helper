# Руководство пользователя

## Установка
Распакуйте архив стандартными средствами Windows в любой удобной папке. Программе не нужны права администратора, она не захламляет реестр и нигде не регистрируется. Можно запускать даже с флэшки.

## Использование
Отчеты брокера ВТБ формата XML нужно поместить в директрию data/reports/vtb. Именно XML, не XLS, не PDF. Получить их можно в личном кабинете на сайте https://lk.olb.ru/Reports/Broker. 

Для выполнения программы нужно запустить файл ndp_invest_helper.exe.

Программа может исполнять пакетные задания из файла task.xml. Результат будет помещен в файл output.txt. Подробности по составлению заданий в разделе "Описание форматов данных".

## Портфель

Формируется из отчетов, расположенных в директории data по умолчанию (задается в файле настроек Settings.xml в аттрибуте reports_dir). Внутри этой директории должна быть директория vtb для отчетов ВТБ, файл cash.xml для наличности.

## Группировка

Есть 4 вида группировки портфеля: по валютам, странам, секторам экономики, типам активов.

При группировке по валютам и типам активов учитывается наличность. По странам и секторам - не учитвается.

Валюты и их курс задаются в файле data\info\currencies.xml. Задается аттрибутом currencies_info в Settings.xml.

Страны задаются в файле data\info\countries.xml. Задается аттрибутом countries_info в Settings.xml.

Валюты задаются в файле data\info\sectors.xml. Задается аттрибутом sectors_info в Settings.xml.

Подробное описание форматов этих файлов есть в разделе "Описание форматов данных".

Неизвестные группы обозначаются "???", в таком случае стоит дополнить соответствующий файл.

## Описание форматов данных

### Файл sectors.xml

Описывает сектора (отрасли) экономики. Допускает вложенную многоуровневую структуру по типу дерева произвольной глубины.

#### Тег row

Описывает сектор.

**Аттрибуты**

Все аттрибуты обязательные.

* id указывает уникальный целочисленный идентификатор сектора
* level указывает уровень вложенности сектора. 0 - условный корневой уровень, в нем нет секторов. 1 - наивысший реальный уровень, содержит самые глобальные сектора вроде финансов, промышленности, добычи сырья и т.п. 2 - более мелкое дробление на сектора, например в добыче сырья могут быть цветная металлургия, чермет, химикаты, стройматериалы.
* name указывает наименование сектора.
* parent_id указывает родительский сектор (на уровень выше, а если арифметически то минус один уровень). Для наивысших секторов указывается 0.

### Файл countries.xml

Описывает страны.

#### Тег countries

Содержит список стран с названиями. Внутри содержит произвольное количество тегов country с описанием отдельной страны. В country аттрибут key указывает двузначный код страны, name - название. Оба аттрибута обязательные.

#### Тег by_region

Содержит список стран по географическим регионам.

#### Тег by_development_level

Содержит список стран по уровням развитости.

### Файл securities.xml

Описывает ценные бумаги.

#### Тег issuer

Описывает эмитента ценной бумаги. Внутри тега issuer может находиться произвольное количество тегов security.

Имеет обязательный аттрибут name, указывающий наименование эмитента, оно должно быть уникальным. Также могут присутствовать аттрибуты country, sector, аналогичные описанным в теге security.

#### Тег security

Описывает ценную бумагу. При анализе бумаги будут группироваться на основе аттрибутов и вложенных тегов country, currency, sec_type, sector.

**Аттрибуты**

* isin указывает уникальный номер бумаги в международном реестре ценных бумаг. Обязательный аттрибут.
* ticker указывает уникальный тикер бумаги. Необязательный аттрибут.
* sec_type указывает тип бумаги. Допустимые значения: share - акция или депозитарная расписка, bond - облигация или еврооблигация, etf - фонд ETF или БПИФ. В принципе допускаются другие значения, например для VTBG я использую gold, т.к. это фонд на физическое золото и относить его к акциям не вижу смысла. Обязательный аттрибут.
* country указывает страну. Смысл Вы вкладываете сами, это может быть страна регистрации эмитента, страна, где ведется бизнес компании, либо что-то другое. Если указан аттрибут, то считается, что доля этой страны 100%.
* currency указывает валюту. Аналогично с country смысл Вы вкладываете сами. Если указан аттрибут, то считается, что доля этой валюты 100%. 
* sector указывает отрасль экономики, точнее её номер из списка в файле отраслей sectors.xml. Если указан аттрибут, то считается, что доля этой отрасли 100%. 
* what_inside применим только для фонда (sec_type="etf") и указывает, что находится внутри фонда. Если указан аттрибут, то считается, что доля этой отрасли 100%. Допустимые значения как в sec_type, кроме etf.

Внутри могут находиться теги country, currency, sector, what_inside в произвольном количестве. Каждый из них будет указывать долю соответствующего типа. Все они имеют одинаковый формат аттрибутов:
* key указывает ключ группы. Для country это будет код страны из countries.xml, для currency код валюты, для sector номер отрасли, для what_inside тип бумаг в составе фонда.
* value указывает долю этого ключа в процентах. Если сумма долей по группе меньше 100%, то оставшаяся часть дополняется ключом "???" автоматически.

### Файл task.xml

#### Тег task

Описывает одну задачу, которую будет выполнять программа и выводить отчет по её результатам. Промежуточные результаты действий не выводятся. Таких тегов может быть сколько угодно. Для каждого будет выведен отдельный результат.

**Аттрибуты**

* name задает описание задачи. На результат не влияет.
* hide_parts_less исключает из результатов группы с долей менее указанной. Доля указывается в процентах. При этом доли не пересчитываются, исключенные группы просто не отображаются. Например, есть две группы в 70% и 30%. При hide_parts_less="50" в результате останется первая группа с долей 70%.
* order_by определяет порядок сортировки результата. Допустимые значения: "key" - по названию группы (наименование страны, валюты и тд), "part" - по размеру группы. Через точку с запятой можно дописать "desc", тогда результат будет упорядочен по убыванию, например, "part;desc". По умолчанию сортировка по размеру по возрастанию.
* remove_isins, remove_tickers указывает какие бумаги нужно удалить из результата. При этом доли будут пересчитаны.
* keep_only_isins, keep_only_tickers указывает какие бумаги нужно оставить в результате, а остальные удалить. При этом доли будут пересчитаны.

Внутри тега task могут встречаться теги действий, описанные ниже.

#### Тег group

Внутри тега task могут встречаться теги group в произвольном количестве. Они группируют портфель по указанному критерию. Каждый следующий тег группирует результат выполнения предыдущего. Таким образом можно сначала сгруппировать портфель по типу активов, оставить только акции, сгруппировать их по странам, исключить российские, сгруппировать оставшиеся по секторам экономики. В итоге получим зарубежные акции, сгруппированные по секторам.

**Аттрибуты**

* by указывает критерий группировки. Обязательный аттрибут. Доступные значения: 
	* country - по странам
	* currency - по валютам
	* type - по типам актива
	* sector - по секторам экономики
* unpack_etf указывает нужно ли заглядывать внутрь ETF при группировке по типам актива. При друггих группировка это делается всегда автоматически. Если значение равно yes, то в результате не будет группы с названием etf. Всё её содержимое будет распределено по остальным группам в долях, указанных в файле data/info/securities.xml в описании соответствующего фонда.
* remove_keys указывает какие группы нужно удалить из результата. При этом доли будут пересчитаны для оставшихся групп. Например, портфель состоит из акций и облигаций поровну. При remove_keys="bond", останется одна группа share, занимающая 100%.
* keep_only_keys указывает какие группы нужно оставить в результате, а остальные удалить. В остальном аналогично remove_keys 
* print_each_action указывает нужно ли печатать результат каждого действия. Если значение "yes", то печатает. Если аттрибут опущен или любое другое значение, то печатается только результат последнего действия.

#### Теги buy/sell

Действия для просмотра, что будет с результатами группироки при докупке/продаже бумаг. Должно располагаться до первого действия группировки group. 

**Аттрибуты**

Обязательно должен быть аттрибут isin или ticker, указывающий на бумагу. Эта бумага должна быть в базе securities.xml.

* isin 
* ticker
* count указывает сколько бумаг купить или продавать. Если при продаже указано больше, чем есть, это не страшно, продадутся все имеющиеся. Обязательный аттрибут для покупки, для продажи можно опустить count, тогда продадутся все имеющиеся.
* price указывает цену покупки. Для новых бумаг при покупке обязательно должна быть указана цена. Для уже имеющихся это не обязательно, при отсутствии аттрибута price будет использована старая цена. Если указать цену, то она будет использована и для старых бумаг. Для продажи цена не указывается. Продажа всегда по текущей цене.
* use_cash указывает будет ли пересчитана наличка. То есть, эмулирована реальная сделка. При значении "no" будет происходить только добавление или удаление бумаги. При любых других значениях или отсутствии аттрибута будет эмулироваться реальная сделка с добавление или убавлением налички. Баланс портфеля останется неизменным.
* currency указывает в какой валюте совершать сделку
